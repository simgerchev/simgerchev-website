---
- name: Deploy app to k3s
  hosts: k3s
  gather_facts: false
  vars:
    app_name: simgerchev-website
    build_image: true
    tag: ""
    registry: "localhost:5000"
    is_default_app: "{{ app_name == 'simgerchev-website' }}"
    project_root: "{{ playbook_dir }}/.."
    app_dir: "{{ 'frontend' if is_default_app else app_name }}"
    k8s_dir: "{{ 'k8s' if is_default_app else 'k8s/' ~ app_name }}"
    namespace: "{{ 'simgerchev-website' if is_default_app else app_name }}"
    deployment: "{{ 'frontend' if is_default_app else app_name }}"
    container: "{{ 'frontend' if is_default_app else app_name }}"
  tasks:
    - name: Validate app directory
      ansible.builtin.stat:
        path: "{{ project_root }}/{{ app_dir }}"
      register: app_dir_stat

    - name: Fail when app directory missing
      ansible.builtin.fail:
        msg: "Application directory '{{ app_dir }}' not found under {{ project_root }}"
      when: not app_dir_stat.stat.exists

    - name: Resolve tag when building
      ansible.builtin.set_fact:
        resolved_tag: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
      when: build_image and (tag | length == 0)

    - name: Fail when tag is required
      ansible.builtin.fail:
        msg: "build_image=false requires tag to be set"
      when: not build_image and (tag | length == 0)

    - name: Use provided tag
      ansible.builtin.set_fact:
        resolved_tag: "{{ tag }}"
      when: tag | length > 0

    - name: Compose image reference
      ansible.builtin.set_fact:
        image: "{{ registry }}/{{ app_name }}:{{ resolved_tag }}"

    - name: Build image
      ansible.builtin.command: "docker build -t {{ image }} {{ app_dir }}"
      args:
        chdir: "{{ project_root }}"
      when: build_image

    - name: Push image
      ansible.builtin.command: "docker push {{ image }}"
      args:
        chdir: "{{ project_root }}"
      when: build_image

    - name: Apply namespace
      ansible.builtin.command: "kubectl apply -f {{ k8s_dir }}/namespace.yaml"
      args:
        chdir: "{{ project_root }}"
      register: namespace_apply
      failed_when: false

    - name: Apply Kubernetes manifests
      ansible.builtin.command: "kubectl apply -f {{ k8s_dir }}/"
      args:
        chdir: "{{ project_root }}"

    - name: Update deployment image
      ansible.builtin.command: "kubectl -n {{ namespace }} set image deployment/{{ deployment }} {{ container }}={{ image }}"
      args:
        chdir: "{{ project_root }}"

    - name: Rollout restart
      ansible.builtin.command: "kubectl -n {{ namespace }} rollout restart deployment/{{ deployment }}"
      args:
        chdir: "{{ project_root }}"

    - name: Wait for rollout
      ansible.builtin.command: "kubectl -n {{ namespace }} rollout status deployment/{{ deployment }}"
      args:
        chdir: "{{ project_root }}"