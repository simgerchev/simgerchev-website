stages:
  - verify
  - gate
  - deploy

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'

variables:
  APP_NAME: "simgerchev-website"
  REGISTRY: "localhost:5000"
  TAG: "latest"

verify_frontend:
  stage: verify
  image: node:20
  script:
    - cd app/simgerchev-website
    - npm ci
    - npm run lint
    - npm run build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

verify_ansible_syntax:
  stage: verify
  image: python:3.12-alpine
  before_script:
    - python -m pip install --no-cache-dir --root-user-action=ignore ansible-core
  script:
    - ansible-playbook -i ops/ansible/inventory.ini ops/ansible/deploy-k3s.yml --syntax-check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

approve_production_deploy:
  stage: gate
  script:
    - echo "Deployment approved manually"
  when: manual
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

deploy_k3s_manual:
  stage: deploy
  image: python:3.12-alpine
  before_script:
    - apk add --no-cache kubectl
    - python -m pip install --no-cache-dir --root-user-action=ignore ansible-core
    - mkdir -p "$HOME/.kube"
    - |
      for candidate in "$KUBECONFIG" "$KUBE_CONFIG" "$HOME/.kube/config" "/root/.kube/config"; do
        if [ -n "$candidate" ] && [ -f "$candidate" ]; then
          export KUBECONFIG="$candidate"
          break
        fi
      done

      if [ -z "$KUBECONFIG" ] || [ ! -f "$KUBECONFIG" ]; then
        KUBECONFIG_B64_VALUE="${KUBECONFIG_CONTENT_B64:-$KUBE_CONFIG_B64}"
        KUBECONFIG_RAW_VALUE="${KUBECONFIG_CONTENT:-${KUBECONFIG:-$KUBE_CONFIG}}"

        if [ -n "$KUBECONFIG_B64_VALUE" ]; then
          echo "$KUBECONFIG_B64_VALUE" | base64 -d > "$HOME/.kube/config"
          export KUBECONFIG="$HOME/.kube/config"
        elif [ -n "$KUBECONFIG_RAW_VALUE" ]; then
          printf '%s' "$KUBECONFIG_RAW_VALUE" > "$HOME/.kube/config"
          export KUBECONFIG="$HOME/.kube/config"
        fi
      fi

      if [ -z "$KUBECONFIG" ] || [ ! -f "$KUBECONFIG" ]; then
        echo "Missing kubeconfig. Set one of: KUBECONFIG (File variable), KUBECONFIG_CONTENT, KUBECONFIG_CONTENT_B64, KUBE_CONFIG, or KUBE_CONFIG_B64"
        echo "Debug (lengths only): KUBECONFIG=${#KUBECONFIG} KUBECONFIG_CONTENT=${#KUBECONFIG_CONTENT} KUBECONFIG_CONTENT_B64=${#KUBECONFIG_CONTENT_B64} KUBE_CONFIG=${#KUBE_CONFIG} KUBE_CONFIG_B64=${#KUBE_CONFIG_B64}"
        echo "If variables are Protected, this job must run on a protected branch/tag."
        exit 1
      fi
    - kubectl cluster-info
  needs:
    - job: verify_ansible_syntax
    - job: approve_production_deploy
  script:
    - |
      if [ -z "$TAG" ]; then
        echo "TAG is required in CI deploy. This pipeline deploys an existing image only."
        exit 1
      fi
    - EXTRA_VARS="app_name=${APP_NAME} registry=${REGISTRY} build_image=false tag=${TAG}"
    - ansible-playbook -i ops/ansible/inventory.ini ops/ansible/deploy-k3s.yml --extra-vars "$EXTRA_VARS"
  when: manual
  allow_failure: false
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
