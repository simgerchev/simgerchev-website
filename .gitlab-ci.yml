stages:
  - verify
  - build
  - gate
  - deploy

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "pipeline"'

variables:
  APP_NAME: "simgerchev-website"
  REGISTRY: "localhost:5000"
  TAG: ""

verify_frontend:
  stage: verify
  image: node:20
  script:
    - cd app/simgerchev-website
    - npm ci
    - npm run lint
    - npm run build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

verify_ansible_syntax:
  stage: verify
  image: python:3.12-alpine
  before_script:
    - python -m pip install --no-cache-dir ansible-core
  script:
    - ansible-playbook -i ops/ansible/inventory.ini ops/ansible/deploy-k3s.yml --syntax-check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

build_image:
  stage: build
  image: docker:27-cli
  services:
    - name: docker:27-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  needs:
    - verify_frontend
  script:
    - |
      if [ -n "$TAG" ]; then
        IMAGE_TAG="$TAG"
      else
        IMAGE_TAG="$(date +%Y%m%d-%H%M%S)-${CI_COMMIT_SHORT_SHA}"
      fi
    - echo "DEPLOY_TAG=${IMAGE_TAG}" > build.env
    - docker build -t "${REGISTRY}/${APP_NAME}:${IMAGE_TAG}" app/simgerchev-website
    - docker push "${REGISTRY}/${APP_NAME}:${IMAGE_TAG}"
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

approve_production_deploy:
  stage: gate
  script:
    - echo "Deployment approved manually"
  when: manual
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

deploy_k3s_manual:
  stage: deploy
  image: python:3.12-alpine
  before_script:
    - apk add --no-cache kubectl
    - python -m pip install --no-cache-dir ansible-core
  needs:
    - job: verify_ansible_syntax
    - job: build_image
      artifacts: true
    - job: approve_production_deploy
  script:
    - |
      EFFECTIVE_TAG="${TAG:-$DEPLOY_TAG}"
      if [ -z "$EFFECTIVE_TAG" ]; then
        echo "No tag available. Set TAG manually or ensure build_image produced DEPLOY_TAG"
        exit 1
      fi
      export EFFECTIVE_TAG
    - EXTRA_VARS="app_name=${APP_NAME} registry=${REGISTRY} build_image=false tag=${EFFECTIVE_TAG}"
    - ansible-playbook -i ops/ansible/inventory.ini ops/ansible/deploy-k3s.yml --extra-vars "$EXTRA_VARS"
  when: manual
  allow_failure: false
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
